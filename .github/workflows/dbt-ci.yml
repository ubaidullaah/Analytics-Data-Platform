name: DBT - Test & Validate

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'DBT_fintech_project/**'
      - '.github/workflows/dbt-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'DBT_fintech_project/**'
      - '.github/workflows/dbt-ci.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  DBT_PROJECT_DIR: 'DBT_fintech_project'

jobs:
  dbt-test:
    name: DBT Test & Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.DBT_PROJECT_DIR }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install DBT and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-snowflake dbt-utils

      - name: Create DBT profiles directory
        run: |
          mkdir -p ~/.dbt

      - name: Set up DBT profile
        run: |
          cat > ~/.dbt/profiles.yml << EOF
          fintech_project:
            target: dev
            outputs:
              dev:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT || 'test_account' }}
                user: ${{ secrets.SNOWFLAKE_USER || 'test_user' }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD || 'test_password' }}
                warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE || 'test_warehouse' }}
                database: ${{ secrets.SNOWFLAKE_DATABASE || 'FINTECH_DW' }}
                schema: ${{ secrets.SNOWFLAKE_SCHEMA || 'ANALYTICS' }}
                threads: 2
          EOF

      - name: Install DBT packages
        run: dbt deps

      - name: Debug DBT connection
        run: dbt debug --target dev
        continue-on-error: true

      - name: Compile DBT models
        run: dbt compile --target dev

      - name: Validate DBT project structure
        run: |
          dbt list --target dev
          dbt show --select models --limit 5 --target dev || true

      - name: Run DBT tests (dry-run)
        run: |
          dbt test --target dev --dry-run || echo "Dry-run tests completed"

      - name: Check for DBT model changes
        id: dbt-changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Checking for DBT model changes..."
            git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(sql|yml|yaml)$' > /tmp/dbt_changes.txt || true
            if [ -s /tmp/dbt_changes.txt ]; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "DBT files changed:"
              cat /tmp/dbt_changes.txt
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate DBT documentation
        run: |
          dbt docs generate --target dev || echo "Documentation generation skipped"

      - name: Upload DBT artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-artifacts
          path: |
            ${{ env.DBT_PROJECT_DIR }}/target/*.json
            ${{ env.DBT_PROJECT_DIR }}/target/manifest.json
          retention-days: 7

  dbt-lint:
    name: DBT SQL Linting
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.DBT_PROJECT_DIR }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SQLFluff with DBT support
        run: |
          pip install sqlfluff sqlfluff-templater-dbt

      - name: Lint DBT models
        run: |
          sqlfluff lint models/ --dialect snowflake --format human || true

      - name: Check SQLFluff rules
        run: |
          sqlfluff lint models/ --dialect snowflake --format github-annotation || true


name: CI - Code Quality & Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  AIRFLOW_VERSION: '3.1.5'

jobs:
  lint-python:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy pylint
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Black (code formatter check)
        run: |
          black --check --diff Airflow/dags/

      - name: Run isort (import sorter check)
        run: |
          isort --check-only --diff Airflow/dags/

      - name: Run Flake8 (linter)
        run: |
          flake8 Airflow/dags/ --max-line-length=120 --extend-ignore=E203,W503 --exclude=__pycache__

      - name: Run Pylint
        run: |
          pylint Airflow/dags/*.py --disable=C0111,R0903 || true

  validate-airflow-dags:
    name: Validate Airflow DAGs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Airflow
        run: |
          python -m pip install --upgrade pip
          pip install "apache-airflow==${{ env.AIRFLOW_VERSION }}" --constraint "https://raw.githubusercontent.com/apache/airflow/constraints-${{ env.AIRFLOW_VERSION }}/constraints-${{ env.PYTHON_VERSION }}.txt"

      - name: Validate DAGs
        env:
          AIRFLOW_HOME: /tmp/airflow
        run: |
          mkdir -p $AIRFLOW_HOME
          export AIRFLOW__CORE__DAGS_FOLDER=Airflow/dags
          python -c "from airflow.models import DagBag; d = DagBag(); print('DAGs loaded:', len(d.dags)); assert len(d.dags) > 0, 'No DAGs found'; [print(f'DAG: {dag_id}') for dag_id in d.dags.keys()]"
          airflow dags list-import-errors

      - name: Check DAG syntax
        run: |
          python -m py_compile Airflow/dags/*.py

  lint-sql:
    name: Lint SQL Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SQLFluff
        run: |
          pip install sqlfluff sqlfluff-templater-dbt

      - name: Lint Snowflake migrations
        run: |
          sqlfluff lint Snowflake/migrations/ --dialect snowflake || true

      - name: Lint DBT models
        run: |
          sqlfluff lint DBT_fintech_project/models/ --dialect snowflake || true

  test-dbt-compile:
    name: Test DBT Compilation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install DBT
        run: |
          python -m pip install --upgrade pip
          pip install dbt-snowflake

      - name: Create DBT profiles directory
        run: |
          mkdir -p ~/.dbt

      - name: Create minimal DBT profile for compilation
        run: |
          cat > ~/.dbt/profiles.yml << EOF
          fintech_project:
            target: dev
            outputs:
              dev:
                type: snowflake
                account: test_account
                user: test_user
                password: test_password
                warehouse: test_warehouse
                database: FINTECH_DW
                schema: ANALYTICS
                threads: 1
          EOF

      - name: Compile DBT models
        working-directory: DBT_fintech_project
        run: |
          dbt deps
          dbt compile --target dev

      - name: Validate DBT project structure
        working-directory: DBT_fintech_project
        run: |
          dbt debug --target dev

  check-yaml:
    name: Validate YAML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate YAML files
        run: |
          yamllint -d '{extends: default, rules: {line-length: {max: 200}}}' Airflow/docker-compose.yaml
          yamllint -d '{extends: default, rules: {line-length: {max: 200}}}' DBT_fintech_project/dbt_project.yml

  check-dockerfile:
    name: Validate Dockerfile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Dockerfile syntax
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Airflow/Dockerfile
          failure-threshold: warning

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint-python, validate-airflow-dags, lint-sql, test-dbt-compile, check-yaml, check-dockerfile, security-scan]
    if: always()
    steps:
      - name: Check job status
        run: |
          echo "All CI checks completed"
          echo "Python linting: ${{ needs.lint-python.result }}"
          echo "Airflow DAG validation: ${{ needs.validate-airflow-dags.result }}"
          echo "SQL linting: ${{ needs.lint-sql.result }}"
          echo "DBT compilation: ${{ needs.test-dbt-compile.result }}"
          echo "YAML validation: ${{ needs.check-yaml.result }}"
          echo "Dockerfile validation: ${{ needs.check-dockerfile.result }}"
          echo "Security scan: ${{ needs.security-scan.result }}"

